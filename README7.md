# Прогноз погоды по названию города или текущему местоположению

# Содержание

1. [Получение информации о погоде по названию города](#1-получение-информации-о-погоде-по-названию-города)
2. [Получение текущего местоположения пользователя](#2-получение-текущего-местоположения-пользователя)
3. [Хранение истории запросов в SQLite](#3-хранение-истории-запросов-в-sqlite)
   1. [Реализация взаимодействия с базой](#31-реализация-взаимодействия-с-базой)
   2. [Отображение истории запросов](#32-отображение-истории-запросов)
4. [Интерфейс программы](#4-интерфейс-программы)
5. [Обработка ошибок](#5-обработка-ошибок)
   1. [Geocoding API](#51-geocoding-api)
   2. [OpenWeatherMap API](#52-openweathermap-api)
   3. [Валидация данных пользователя](#53-валидация-данных-пользователя)



# План реализации
## 1. Получение информации о погоде по названию города

Для получения данных о погоде будут использоваться два API от OpenWeatherMap:

1. Geocoding API: позволяет по названию города получить его координаты (широту и долготу).
    
    URL: http://api.openweathermap.org/geo/1.0/direct
    
    LIB: `requests`
    
    Пример запроса:
    
    ```bash
    http://api.openweathermap.org/geo/1.0/direct?q=Санкт-Петербург&limit=1&appid=API_KEY
    ```
    Пример ответа:
    
    ```json5
    [
        {
            "name": "Saint Petersburg",
            "local_names": {
                "ru": "Санкт-Петербург",
                "en": "Saint Petersburg"
            },
            "lat": 59.938732,
            "lon": 30.316229,
            "country": "RU"
        }
    ]
    ```
    На основании ответа мы берем lat и lon для следующего запроса.

2. OpenWeatherMap API: позволяет получить данные о текущей погоде по координатам.

    URL: https://api.openweathermap.org/data/2.5/weather
    
    LIB: `requests`
    
    Пример запроса:
    
    ```bash
    https://api.openweathermap.org/data/2.5/weather?lat=59.938732&lon=30.316229&units=metric&lang=ru&appid=API_KEY
    ```
    Пример ответа:
    
    ```json
    
    {
        "coord": {"lon": 30.3162, "lat": 59.9387},
        "weather": [
            {"id": 804, "main": "Clouds", "description": "пасмурно", "icon": "04d"}
        ],
        "main": {
            "temp": 12.3,
            "feels_like": 11.4,
            "temp_min": 12.0,
            "temp_max": 13.0,
            "pressure": 1012,
            "humidity": 72
        },
        "wind": {"speed": 5.0, "deg": 180},
        "timezone": 10800,
        "name": "Saint Petersburg"
    }
    ```
    
    Здесь нас интересуют: weather.description, main.temp, main.feels_like, wind.speed.

## 2. Получение текущего местоположения пользователя

Для определения текущего местоположения будет использоваться:

geocoder.ipinfo: определяет координаты на основе IP-адреса пользователя.

LIB: `geocoder`

Пример:
```python
import geocoder
g = geocoder.ipinfo('me')
print(g.latlng)  # [59.938732, 30.316229]
```
Далее эти координаты используются для запроса к OpenWeatherMap API (см. выше).

## 3. Хранение истории запросов в SQLite

История запросов будет храниться в базе данных SQLite. Для этого создадим таблицу weather_requests со следующими полями:

LIB: `mysqlconnector`

`id` — уникальный идентификатор запроса.

`created_at` — дата и время выполнения запроса.

`query_type` — тип запроса: city (по названию города) или location (по текущему местоположению).

`query_data` — данные запроса пользователя: название города или координаты.

`response_data` — полный JSON-ответ от OpenWeatherMap.

Пример структуры таблицы:

```sql

CREATE TABLE weather_requests (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    created_at DATETIME NOT NULL,
    query_type VARCHAR(4) NOT NULL,
    query_data VARCHAR(256) NOT NULL,
    response_data TEXT NOT NULL
);
```

### 3.1 Реализация взаимодействия с базой

При старте программы будет проверяться наличие базы данных. Если её нет, создаётся файл weather_history.db 
с таблицей weather_requests. При каждом запросе сохраняются данные о запросе пользователя и полном ответе от 
OpenWeatherMap в базу. История запросов будет выводиться по команде пользователя.

### 3.2 Отображение истории запросов

1. Шаг 1: Пользователь запрашивает историю. Программа выводит список запросов с нумерацией и названием городов или 
текстом "текущая локация" (если это запрос по местоположению).

   Пример:
   
   ```
   Последние 5 запросов:
   1. Санкт-Петербург
   2. Москва
   3. Текущая локация
   4. Екатеринбург
   5. Казань
   ```

2. Шаг 2: Пользователь вводит номер записи из списка.
3. Шаг 3: Программа выводит подробную информацию о выбранном запросе, как в случае обычного запроса погоды.

   Пример:
   ```
   Вы выбрали: Санкт-Петербург
   Текущее время: 2023-10-03 09:48:47+03:00
   Название города: Санкт-Петербург
   Погодные условия: облачно
   Текущая температура: 12 С°
   Ощущается как: 11 С°
   Скорость ветра: 5 м/c
   ```
## 4. Интерфейс программы
Программа позволяет:

1. Определять текущую погоду в указанном городе.
2. Определять текущую погоду по геолокации пользователя.
3. Просматривать историю последних запросов.
4. Отображать сохраненные данные о погоде по выбранному запросу.

Меню:

```
Выберите действие:
1. Узнать погоду в городе
2. Узнать погоду по текущему местоположению
3. Посмотреть историю запросов
4. Выйти
Ваш выбор:
```

## 5. Обработка ошибок

### 5.1 Geocoding API

ConnectionError:"Ошибка: не удалось подключиться к серверу для определения координат. Проверьте интернет-соединение."

TimeoutError:"Ошибка: превышено время ожидания ответа от сервера для определения координат. Попробуйте снова позже."

HTTPError (404 Not Found):"Ошибка: введенный город не найден в базе координат. Проверьте правильность ввода."

HTTPError (429 Too Many Requests):"Ошибка: превышен лимит запросов к серверу геокодирования. Попробуйте позже."


### 5.2 OpenWeatherMap API

ConnectionError:"Ошибка: не удалось подключиться к серверу OpenWeatherMap. Проверьте интернет-соединение."

TimeoutError:"Ошибка: превышено время ожидания ответа от сервера OpenWeatherMap. Попробуйте снова позже."

HTTPError (404 Not Found):"Ошибка: не удалось получить погодные данные для введенных координат. 
Проверьте правильность данных."

HTTPError (429 Too Many Requests):"Ошибка: превышен лимит запросов к серверу OpenWeatherMap. 
Подождите и попробуйте снова."

### 5.3 Валидация данных пользователя

Пустой ввод:"Ошибка: название города не может быть пустым. Пожалуйста, введите корректное название."

Некорректный ввод:"Ошибка: название города должно содержать только буквы. Проверьте ввод и повторите."

Неверный выбор в истории запросов:"Ошибка: выбранный номер отсутствует в списке истории. 
Введите номер из предложенного списка."



